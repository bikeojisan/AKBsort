<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AKB48ソート</title>
<style>
  /* BUILD: clean-rebuild v3 (with fixes) */
  :root{
    --gap: 14px;
    --card-max: clamp(150px, 42vw, 420px);
    --center-w: clamp(80px, 12vw, 120px);
    --btn-h: 56px;
    --radius: 18px;
  }

  *{box-sizing:border-box}
  body{font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif; margin:0; background:#0b0d0f; color:#eef1f4;}
  header{display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid #20252b; position:sticky; top:0; backdrop-filter: blur(6px); background:rgba(11,13,15,.7);}
  header h1{font-size:18px; margin:0; font-weight:700;}
  #progressWrap{display:flex; align-items:center; gap:12px; margin-left:auto; min-width:260px;}
  #bar{flex:1; height:10px; background:#1a1f25; border-radius:999px; overflow:hidden;}
  #bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#66d1ff,#7cffc4); transition:width .2s ease;}
  #pct{font-variant-numeric: tabular-nums; min-width:52px; text-align:right;}
  #count{font-variant-numeric: tabular-nums; font-size:12px; opacity:.8; white-space:nowrap;}
  main{max-width:1200px; margin:18px auto; padding:0 16px;}

  /* 常に横3列（中央は固定幅、左右は自動） */
  .arena{ display:grid; grid-template-columns: minmax(0,1fr) var(--center-w) minmax(0,1fr); align-items:center; gap: var(--gap); }
  .side{ display:flex; flex-direction:column; align-items:center; gap:12px; width:100%; min-width:0; }
  .tieCol{ width: var(--center-w); display:flex; align-items:center; justify-content:center; }

  /* カードは列幅にフィット＋正方形、画像はカバー */
  .picCard{ position:relative; width:min(100%, var(--card-max)); max-width:var(--card-max); aspect-ratio:1/1; height:auto; border-radius:var(--radius); background:#0f1317; border:1px solid #1f262d; overflow:hidden; box-shadow:0 6px 30px rgba(0,0,0,.35); }
  .picCard .stage{ position:absolute; inset:0; }
  .stage img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity .24s linear; backface-visibility:hidden; transform: translateZ(0);}
  .stage img.active{ opacity:1; }

  .choice-btn{ width:min(100%, var(--card-max)); max-width:var(--card-max); height:var(--btn-h); border-radius:12px; border:1px solid #28323a; background:#161b20; color:#e9eef3; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 14px; cursor:pointer; transition:transform .03s ease, background .2s; }
  .choice-btn:hover{ background:#1b2127; }
  .choice-btn:active{ transform:translateY(1px); }

  .tie-btn{ width:100%; height:var(--btn-h); border-radius:999px; border:1px solid #28323a; background:#161b20; color:#e9eef3; cursor:pointer; transition:background .2s; }
  .tie-btn:hover{ background:#1b2127; }
  .tie-btn:focus, .tie-btn:focus-visible{ outline:none; box-shadow:0 0 0 2px rgba(124,255,196,.35); }

  .hidden{display:none !important;}
  .panel{background:#0f1317; border:1px solid #1f262d; border-radius:16px; padding:12px 14px;}
  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .toolbar button{height:36px; border-radius:10px; border:1px solid #28323a; background:#12171c; color:#e9eef3; padding:0 10px; cursor:pointer;}
  .toolbar button[disabled]{opacity:.45; cursor:not-allowed;}

  .result{display:grid; gap:8px; margin-top:14px;}
  .rankRow{display:flex; gap:10px; align-items:center; padding:10px; border:1px solid #1f262d; border-radius:12px; background:#0b0f12;}
  .rankNo{font-weight:700; width:44px; text-align:right;}
  .footnote{opacity:.65; font-size:12px; margin-top:10px;}

  /* 端末幅に応じて縮小（列は常に3つ） */
  @media (max-width: 900px){ :root{ --btn-h: 48px; --gap: 10px; --card-max: clamp(130px, 40vw, 320px);} }
  @media (max-width: 600px){ :root{ --gap: 8px;  --card-max: clamp(120px, 38vw, 260px);} }

  /* aspect-ratio未対応ブラウザ フォールバック */
  @supports not (aspect-ratio: 1/1){
    .picCard{ position:relative; height:auto; }
    .picCard::before{ content:""; display:block; width:100%; padding-top:100%; }
    .picCard .stage{ position:absolute; inset:0; }
  }

  /* メンバー選択UI */
  .setup-toolbar{ display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px; }
  .setup-toolbar input{ height:36px; border-radius:10px; border:1px solid #28323a; background:#12171c; color:#e9eef3; padding:0 10px; }
  .setup-gens{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{ border:1px solid #28323a; padding:6px 10px; border-radius:999px; background:#12171c; cursor:pointer; user-select:none; }
  .chip.active{ background:#1b2127; box-shadow:0 0 0 2px rgba(124,255,196,.25) inset; }
  .setup-actions-small{ display:flex; gap:8px; flex-wrap:wrap; }
  .setup-actions-small button{ height:32px; border-radius:8px; border:1px solid #28323a; background:#12171c; color:#e9eef3; padding:0 8px; }
  .checklist{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:8px; padding:6px 0; }
  .checklist label{ display:flex; align-items:center; gap:8px; padding:8px; border:1px solid #1f262d; border-radius:8px; background:#0b0f12; cursor:pointer; }
  .checklist input{ width:16px; height:16px; }
  .setup-actions{ display:flex; justify-content:flex-end; margin-top:10px; }
  .start-btn{ height:40px; border-radius:10px; border:1px solid #28323a; background:#2a6cff; color:#fff; padding:0 12px; cursor:pointer; }
  @media (max-width:600px){ .checklist{ grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); } }
</style>
</head>
<body>
<header>
  <h1>AKB48ソート</h1>
  <div id="progressWrap" class="panel" aria-label="進捗状況">
    <div id="bar" aria-hidden="true"><i></i></div>
    <div id="pct" aria-live="polite">0%</div>
    <div id="count">比較: 0 / 0</div>
  </div>
</header>

<main>
  <div class="panel toolbar" style="margin-bottom:14px;">
    <button id="resetBtn" title="最初からやり直す">🔄 はじめから</button>
    <button id="editBtn" title="メンバーを選ぶ">👥 メンバー選択</button>
    <button id="undoBtn" title="1手戻す" disabled>↩ 戻す</button>
    <button id="exportBtn" class="hidden" title="結果をテキストとして保存">📄 結果を保存</button>
    <button id="tweetBtn"  class="hidden" title="上位7位をXで共有">𝕏 結果を共有</button>
  </div>

  <!-- メンバー選択パネル -->
  <div id="setupWrap" class="panel hidden" style="margin-bottom:14px;">
    <h2 style="margin:0 0 10px;">メンバー選択</h2>
    <div class="setup-toolbar">
      <input id="searchInput" type="search" placeholder="名前で絞り込み" />
      <div id="genFilters" class="setup-gens hidden"></div>
      <div class="setup-actions-small">
        <button id="selectAll" type="button">表示中を全選択</button>
        <button id="clearAll" type="button">表示中を全解除</button>
      </div>
    </div>
    <div id="memberChecklist" class="checklist"></div>
    <div class="setup-actions">
      <button id="startBtn" class="start-btn" type="button">このメンバーでソート開始</button>
    </div>
  </div>

  <div class="arena" id="arena">
    <div class="side">
      <div class="picCard"><div class="stage" id="stageL"></div></div>
      <button class="choice-btn" id="btnL" aria-label="左を選ぶ">(左)</button>
    </div>
    <div class="tieCol">
      <button class="tie-btn" id="btnTie" aria-label="引き分け">引き分け</button>
    </div>
    <div class="side">
      <div class="picCard"><div class="stage" id="stageR"></div></div>
      <button class="choice-btn" id="btnR" aria-label="右を選ぶ">(右)</button>
    </div>
  </div>

  <div id="resultWrap" class="hidden" aria-live="polite">
    <h2 style="margin:10px 0 6px;">最終結果</h2>
    <div id="resultList" class="result"></div>
    <div class="footnote">※同率の場合、同順位を表示します。</div>
  </div>
</main>

<script>
/* ===== メンバー（43名） ===== */
const MEMBERS = [
"岩立沙穂","福岡聖菜","向井地美音","小栗有以","倉野尾成美","坂川陽香","下尾みう","髙橋彩音",
"徳永羚海","永野芹佳","橋本陽菜","千葉恵里","鈴木くるみ","田口愛佳","長友彩海","武藤小麟",
"山内瑞葵","大盛真歩","太田有紀","佐藤綺星","橋本恵理子","畠山希美","平田侑希","布袋百椛",
"正鋳真優","水島美結","山﨑空","秋山由奈","新井彩永","工藤華純","久保姫菜乃","迫由芽実",
"成田香姫奈","八木愛月","山口結愛","伊藤百花","奥本カイリ","川村結衣","白鳥沙怜","花田藍衣",
"大賀彩姫","近藤沙樹","丸山ひなた"
];

/* ===== 期生マップ（全員分・編集OK） ===== */
const GEN_BY_NAME = {
  // 13期
  "岩立沙穂": "13期",

  // 15期
  "福岡聖菜": "15期",
  "向井地美音": "15期",

  // チーム8
  "小栗有以": "チーム8",
  "倉野尾成美": "チーム8",
  "坂川陽香": "チーム8",
  "下尾みう": "チーム8",
  "髙橋彩音": "チーム8",
  "徳永羚海": "チーム8",
  "永野芹佳": "チーム8",
  "橋本陽菜": "チーム8",

  // ドラフト 2期
  "千葉恵里": "ドラフト 2期",

  // 16期
  "鈴木くるみ": "16期",
  "田口愛佳": "16期",
  "長友彩海": "16期",
  "武藤小麟": "16期",
  "山内瑞葵": "16期",

  // ドラフト 3期
  "大盛真歩": "ドラフト 3期",

  // 17期
  "太田有紀": "17期",
  "佐藤綺星": "17期",
  "橋本恵理子": "17期",
  "畠山希美": "17期",
  "平田侑希": "17期",
  "布袋百椛": "17期",
  "正鋳真優": "17期",
  "水島美結": "17期",
  "山﨑空": "17期",

  // 18期
  "秋山由奈": "18期",
  "新井彩永": "18期",
  "工藤華純": "18期",
  "久保姫菜乃": "18期",
  "迫由芽実": "18期",
  "成田香姫奈": "18期",
  "八木愛月": "18期",
  "山口結愛": "18期",

  // 19期
  "伊藤百花": "19期",
  "奥本カイリ": "19期",
  "川村結衣": "19期",
  "白鳥沙怜": "19期",
  "花田藍衣": "19期",

  // 20期
  "大賀彩姫": "20期",
  "近藤沙樹": "20期",
  "丸山ひなた": "20期",
};

const SELECTED_KEY = 'akb-selected-v1';
let SELECTED = [];

/* ===== 参照 ===== */
const $ = (s)=>document.querySelector(s);
const stageL=$("#stageL"), stageR=$("#stageR");
const btnL=$("#btnL"), btnR=$("#btnR"), btnTie=$("#btnTie");
const bar=$("#bar>i"), pct=$("#pct"), countEl=$("#count");
const arena=$("#arena"), resultWrap=$("#resultWrap"), resultList=$("#resultList");
const resetBtn=$("#resetBtn"), undoBtn=$("#undoBtn"), exportBtn=$("#exportBtn"), tweetBtn=$("#tweetBtn"), editBtn=$("#editBtn");
// setup
const setupWrap=$("#setupWrap"), searchInput=$("#searchInput"), genFilters=$("#genFilters"), memberChecklist=$("#memberChecklist"), startBtn=$("#startBtn"), selAllBtn=$("#selectAll"), clrAllBtn=$("#clearAll");

/* 共有用のサイトURL（クエリ/ハッシュと index.html を除去） */
const SITE_URL = (() => {
  const u = new URL(location.href);
  u.search = ""; u.hash = "";
  return u.href.replace(/index\.html?$/i, "");
})();

/* ===== 進捗イージング ===== */
const PROGRESS_EASE_GAMMA = 2.2;
function easedPercent(done, total, finished){
  if (finished) return 100;
  if (!total)   return 100;
  if (done === 0) return 0;
  const x = Math.min(done / total, 0.999);
  const y0 = 1 - Math.pow(1 - x, PROGRESS_EASE_GAMMA);
  return Math.min(99, Math.max(0, Math.round(y0 * 100)));
}

/***********************
 * メンバー選択ロジック
 ***********************/
const activeGens = new Set();
function uniqueGens(){ const s=new Set(); for(const n of MEMBERS){ const g=GEN_BY_NAME[n]; if(g) s.add(g); } return Array.from(s).sort(); }
function loadSelected(){ try{ const arr=JSON.parse(localStorage.getItem(SELECTED_KEY)||'[]'); if(Array.isArray(arr) && arr.length){ return new Set(arr.filter(n=>MEMBERS.includes(n))); } }catch{} return new Set(MEMBERS); }
function saveSelected(sel){ localStorage.setItem(SELECTED_KEY, JSON.stringify(Array.from(sel))); }
let selectedSet = null;
function visibleNames(){
  const q=(searchInput?.value||'').trim();
  const useGen = activeGens.size>0;
  return MEMBERS.filter(n=>{
    if(useGen){ const g=GEN_BY_NAME[n]||'未設定'; if(!activeGens.has(g)) return false; }
    if(q){ return n.includes(q); }
    return true;
  });
}
function renderGenFilters(){
  const gens=uniqueGens();
  if(!genFilters) return;
  if(gens.length===0){ genFilters.classList.add('hidden'); genFilters.innerHTML=''; return; }
  genFilters.classList.remove('hidden');
  genFilters.innerHTML = gens.map(g=>`<span class="chip" data-gen="${g}">${g}</span>`).join('');
  genFilters.querySelectorAll('.chip').forEach(ch=>{
    const g=ch.dataset.gen;
    if(activeGens.has(g)) ch.classList.add('active');
    ch.addEventListener('click', ()=>{
      if(activeGens.has(g)) activeGens.delete(g); else activeGens.add(g);
      ch.classList.toggle('active');
      renderChecklist();
    });
  });
}
function renderChecklist(){
  if(!memberChecklist) return;
  const names=visibleNames();
  memberChecklist.innerHTML = names.map(n=>{
    const checked = selectedSet.has(n)?'checked':'';
    return `<label><input type="checkbox" value="${n}" ${checked}> <span>${n}</span></label>`;
  }).join('');
  memberChecklist.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      if(cb.checked) selectedSet.add(cb.value); else selectedSet.delete(cb.value);
      saveSelected(selectedSet);
    });
  });
}
function toggleSetup(show){
  setupWrap.classList.toggle('hidden', !show);
  arena.classList.toggle('hidden', show);
  resultWrap.classList.add('hidden');
}

/* ===== 画像マップ ===== */
let IMAGE_MAP = {};
async function loadImageMapJson(){
  try{
    const res = await fetch("image-map.json", { cache:"no-store" });
    if(!res.ok) return {};
    return await res.json();
  }catch(e){ return {}; }
}
const cache = new Map();
const placeholderSrc = (name)=>
  `https://placehold.co/800x800/png?text=${encodeURIComponent(name)}`;

function ensureStages(stageEl){
  if(stageEl.children.length===0){
    const a=document.createElement("img"), b=document.createElement("img");
    for (const el of [a,b]){ el.decoding="async"; el.referrerPolicy="no-referrer"; el.loading="eager"; el.alt=""; }
    stageEl.appendChild(a); stageEl.appendChild(b); a.className="active";
  }
}
function showImage(stageEl, name){
  ensureStages(stageEl);
  const imgA=stageEl.children[0], imgB=stageEl.children[1];
  const active=imgA.classList.contains("active")?imgA:imgB;
  const idle=active===imgA?imgB:imgA;

  const primary = IMAGE_MAP[name] || placeholderSrc(name);
  const candidates = [primary];
  if(!primary.startsWith("data:") && !primary.includes("placehold.co")){
    candidates.push(placeholderSrc(name)); // フォールバック
  }

  function swapTo(src){
    idle.src=src; idle.alt=name; active.alt=name;
    requestAnimationFrame(()=>{ active.classList.remove("active"); idle.classList.add("active"); });
  }
  function tryLoad(idx){
    const src=candidates[idx];
    if(cache.has(src)) return swapTo(src);
    const tmp=new Image(); tmp.referrerPolicy="no-referrer";
    tmp.onload=()=>{ cache.set(src,true); swapTo(src); };
    tmp.onerror=()=>{ if(idx+1<candidates.length) tryLoad(idx+1); else { const fb=placeholderSrc(name); cache.set(fb,true); swapTo(fb); } };
    tmp.src=src;
  }
  tryLoad(0);
}

/* ===== 比較回数（初期上限＋動的分母） ===== */
function computeOptimalTotal(n){
  if(n<=1) return 0;
  const heap = Array(n).fill(1);
  const up=(i)=>{while(i>0){const p=(i-1)>>1;if(heap[p]<=heap[i])break;[heap[p],heap[i]]=[heap[i],heap[p]];i=p;}};
  const down=(i)=>{for(;;){let l=i*2+1,r=l+1,s=i;if(l<heap.length&&heap[l]<heap[s])s=l;if(r<heap.length&&heap[r]<heap[s])s=r;if(s===i)break;[heap[i],heap[s]]=[heap[s],heap[i]];i=s;}};
  for(let i=(heap.length>>1)-1;i>=0;i--) down(i);
  const pop=()=>{const x=heap[0];const y=heap.pop();if(heap.length){heap[0]=y;down(0);}return x;};
  const push=(v)=>{heap.push(v);up(heap.length-1);};
  let total=0; while(heap.length>1){ const a=pop(), b=pop(); total+=(a+b-1); push(a+b);} return total;
}
function huffmanCostFromSizes(sizes){
  const heap = sizes.filter(x=>x>0).slice(); if(heap.length<=1) return 0;
  const up=(i)=>{while(i>0){const p=(i-1)>>1;if(heap[p]<=heap[i])break;[heap[p],heap[i]]=[heap[i],heap[p]];i=p;}};
  const down=(i)=>{for(;;){let l=i*2+1,r=l+1,s=i;if(l<heap.length&&heap[l]<heap[s])s=l;if(r<heap.length&&heap[r]<heap[s])s=r;if(s===i)break;[heap[i],heap[s]]=[heap[s],heap[i]];i=s;}};
  for(let i=(heap.length>>1)-1;i>=0;i--) down(i);
  const pop=()=>{const x=heap[0];const y=heap.pop();if(heap.length){heap[0]=y;down(0);}return x;};
  const push=(v)=>{heap.push(v);up(heap.length-1);};
  let cost=0; while(heap.length>1){ const a=pop(), b=pop(); cost+=(a+b-1); push(a+b);} return cost;
}
function recomputeTotalUpperBound(s){
  const otherSizes = s.runs.map(r=>r.length);
  if(s.active){
    const leftRem = s.active.left.length - s.active.i;
    const rightRem = s.active.right.length - s.active.j;
    const mergedSoFar = s.active.merged.length;
    const pairCost = (leftRem>0 && rightRem>0) ? (leftRem + rightRem - 1) : 0;
    const newRunSize = mergedSoFar + leftRem + rightRem;
    const sizesAfter = newRunSize>0 ? [newRunSize, ...otherSizes] : otherSizes.slice();
    return s.done + pairCost + huffmanCostFromSizes(sizesAfter);
  }
  return s.done + huffmanCostFromSizes(otherSizes);
}

/* ===== State & 永続化 ===== */
const STORAGE_KEY = "akb-ranker-v6";
function createNewState(names){ return { runs:names.map(n=>[n]), active:null, done:0, total:computeOptimalTotal(names.length), ties:new Map(), finished:false, final:[] }; }
function serializeState(s){ const tiesObj={}; s.ties.forEach((set,k)=>{tiesObj[k]=Array.from(set)}); return JSON.stringify({runs:s.runs,active:s.active,done:s.done,total:s.total,ties:tiesObj,finished:s.finished,final:s.final}); }
function deserializeState(json){ try{ const o=JSON.parse(json); const ties=new Map(Object.entries(o.ties||{}).map(([k,arr])=>[k,new Set(arr)])); return {runs:o.runs,active:o.active,done:o.done,total:o.total,ties,finished:o.finished,final:o.final}; }catch{ return null; } }
function saveState(s){ localStorage.setItem(STORAGE_KEY, serializeState(s)); }
function loadState(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return null; return deserializeState(raw);}catch{ return null; } }
const saveStateDebounced = (()=>{ let t=null; return (s)=>{ clearTimeout(t); t=setTimeout(()=>saveState(s), 16); }; })();

/* ===== マージ進行 ===== */
function prepareNextPair(s){
  if(s.active && s.active.i < s.active.left.length && s.active.j < s.active.right.length) return;
  if(s.active){
    const a=s.active;
    while(a.i<a.left.length)  a.merged.push(a.left[a.i++]);
    while(a.j<a.right.length) a.merged.push(a.right[a.j++]);
    s.runs.push(a.merged); s.active=null;
  }
  if(s.runs.length===1){ s.finished=true; s.final=s.runs[0]; return; }
  if(s.runs.length>=2){
    s.runs.sort((A,B)=>A.length-B.length);
    const left=s.runs.shift(), right=s.runs.shift();
    s.active = { left, right, i:0, j:0, merged:[] };
    return prepareNextPair(s);
  }
}

/* ===== Undo & 操作 ===== */
const history=[]; function pushHistory(s){ history.push(serializeState(s)); undoBtn.disabled = history.length===0; }
function undo(){ if(!history.length) return; const snap=history.pop(); const prev=deserializeState(snap); if(prev){ state=prev; render(true); } undoBtn.disabled = history.length===0; }

function pick(s, which){
  if(s.finished) return; prepareNextPair(s); if(s.finished) return;
  pushHistory(s);
  const a=s.active; const L=a.left[a.i], R=a.right[a.j];
  if(which==="L"){ a.merged.push(L); a.i++; }
  else if(which==="R"){ a.merged.push(R); a.j++; }
  else { a.merged.push(L); a.merged.push(R); a.i++; a.j++; if(!s.ties.has(L)) s.ties.set(L,new Set()); if(!s.ties.has(R)) s.ties.set(R,new Set()); s.ties.get(L).add(R); s.ties.get(R).add(L); }
  s.done++; prepareNextPair(s);
}

/* ===== 描画 ===== */
function updateProgress(s){
  const totalDyn = recomputeTotalUpperBound(s);
  if (s.finished) { bar.style.width="100%"; pct.textContent="100%"; countEl.textContent=`比較: ${s.done} / ${s.done}`; }
  else { const p=easedPercent(s.done,totalDyn,s.finished); bar.style.width=p+"%"; pct.textContent=p+"%"; countEl.textContent=`比較: ${s.done} / ${totalDyn}`; }
}

function render(skipSave){
  updateProgress(state);
  const finished = !!state.finished;
  exportBtn.classList.toggle("hidden", !finished);
  tweetBtn.classList.toggle("hidden", !finished);
  undoBtn.disabled = history.length===0;
  if(finished){ arena.classList.add("hidden"); resultWrap.classList.remove("hidden"); renderResult(); if(!skipSave) saveStateDebounced(state); return; }
  prepareNextPair(state); if(state.finished){ render(); return; }
  const a=state.active, L=a.left[a.i], R=a.right[a.j];
  showImage(stageL, L); showImage(stageR, R); btnL.textContent=L; btnR.textContent=R;
  arena.classList.remove("hidden"); resultWrap.classList.add("hidden"); if(!skipSave) saveStateDebounced(state);
}

function buildTieGroupsInOrder(){
  const adj=state.ties, seen=new Set(), groups=[];
  for(const name of state.final){
    if(seen.has(name)) continue;
    const group=[], q=[name]; seen.add(name);
    while(q.length){
      const u=q.shift(); group.push(u);
      if(adj.has(u)){ for(const v of adj.get(u)){ if(!seen.has(v)){ seen.add(v); q.push(v); } } }
    }
    groups.push(group);
  }
  return groups;
}

/* タイは同順位で個別行 */
function renderResult(){
  resultList.innerHTML="";
  const groups = buildTieGroupsInOrder();
  let rank = 1;
  for(const group of groups){
    for(const name of group){
      const row=document.createElement("div"); row.className="rankRow";
      const no=document.createElement("div"); no.className="rankNo"; no.textContent=rank;
      const nm=document.createElement("div"); nm.textContent=name;
      row.appendChild(no); row.appendChild(nm);
      resultList.appendChild(row);
    }
    rank += group.length;
  }
}

function buildResultLines(){ const groups=buildTieGroupsInOrder(); const lines=[]; let rank=1; for(const g of groups){ for(const name of g){ lines.push(`${rank}. ${name}`); } rank+=g.length; } return lines; }
function buildTopNLines(n){ const groups=buildTieGroupsInOrder(); const lines=[]; let rank=1; for(const g of groups){ if(rank>n) break; for(const name of g){ lines.push(`${rank}. ${name}`); } rank+=g.length; } return lines; }
function composeTweetTop7(){
  const MAX=280, header="AKB48ソート結果", tags="#AKBソート", lines=buildTopNLines(7);
  let parts=[header];
  for(const line of lines){
    const next=parts.join("\n")+"\n"+line;
    if(next.length<=MAX){ parts.push(line);}
    else {
      const remain=lines.length-(parts.length-1);
      const tail=`…他${remain}行`;
      if((parts.join("\n")+"\n"+tail).length<=MAX) parts.push(tail);
      break;
    }
  }
  let text=parts.join("\n");
  if((text+"\n"+tags).length<=MAX) text += "\n"+tags;
  return text;
}

/* ===== 入力イベント ===== */
function onChoose(which){ pick(state, which); render(); }
const USE_POINTER = window.PointerEvent !== undefined;
const bind = (el, type, which) => el.addEventListener(type, (e)=>{ e.preventDefault(); onChoose(which); }, { passive:false });
if (USE_POINTER) { bind(btnL,'pointerdown','L'); bind(btnR,'pointerdown','R'); bind(btnTie,'pointerdown','T'); }
else { bind(btnL,'click','L'); bind(btnR,'click','R'); bind(btnTie,'click','T'); }

document.addEventListener("keydown",(e)=>{
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); return; }
  if(state.finished) return;
  if(e.key==="ArrowLeft"){ onChoose("L"); }
  else if(e.key==="ArrowRight"){ onChoose("R"); }
  else if(e.key==="ArrowDown" || e.key===" "){ e.preventDefault(); onChoose("T"); }
});

/* リセット：保存クリアして新規開始 */
resetBtn.addEventListener("click", ()=>{
  if(confirm("最初からやり直しますか？")){
    const pool = (SELECTED && SELECTED.length)? SELECTED.slice() : MEMBERS.slice();
    try{ localStorage.removeItem(STORAGE_KEY); }catch{}
    state=createNewState(pool);
    history.length = 0;
    undoBtn.disabled = true;
    render();
  }
});
undoBtn.addEventListener('click', ()=>{ undo(); });

exportBtn.addEventListener("click", ()=>{
  if(!state.finished) return;
  const blob=new Blob([buildResultLines().join("\n")],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="akb_ranking.txt"; a.click(); URL.revokeObjectURL(url);
});

/* ツイート：サイトURLも添付 */
tweetBtn.addEventListener("click", ()=>{
  if(!state.finished) return;
  const text = composeTweetTop7();
  const share = new URL("https://twitter.com/intent/tweet");
  share.searchParams.set("text", text);
  share.searchParams.set("url", SITE_URL); // ← サイトURLを添付
  window.open(share.toString(), "_blank", "noopener");
});

/* メンバー選択UI */
editBtn?.addEventListener('click', ()=>{
  selectedSet = loadSelected();
  renderGenFilters();
  renderChecklist();
  toggleSetup(true);
});
searchInput?.addEventListener('input', ()=>{ renderChecklist(); });
selAllBtn?.addEventListener('click', ()=>{ visibleNames().forEach(n=>selectedSet.add(n)); saveSelected(selectedSet); renderChecklist(); });
clrAllBtn?.addEventListener('click', ()=>{ visibleNames().forEach(n=>selectedSet.delete(n)); saveSelected(selectedSet); renderChecklist(); });

/* ✅ 開始：UIから直接取得して反映（取りこぼし防止） */
startBtn?.addEventListener('click', ()=>{
  const arr = Array.from(
    document.querySelectorAll('#memberChecklist input[type="checkbox"]:checked')
  ).map(el => el.value);

  if(arr.length < 2){
    alert('2人以上選んでください');
    return;
  }
  selectedSet = new Set(arr);
  saveSelected(selectedSet);

  SELECTED = arr.slice();

  try{ localStorage.removeItem(STORAGE_KEY); }catch{}
  history.length = 0;
  undoBtn.disabled = true;

  state = createNewState(SELECTED.slice());
  toggleSetup(false);
  render();
});

/* ===== 初期化 ===== */
let state=null;
(async function init(){
  IMAGE_MAP = await loadImageMapJson(); // image-map.json が無くてもOK
  const savedSel = loadSelected();
  SELECTED = Array.from(savedSel);
  const savedState = loadState();
  if(savedState){
    state = savedState;
    toggleSetup(false);
  }else{
    // 初回はメンバー選択（選択は全員が初期値）
    selectedSet = savedSel;
    renderGenFilters();
    renderChecklist();
    toggleSetup(true);
    state = createNewState(SELECTED.slice()); // 準備だけ
  }
  render();
})();
</script>
</body>
</html>
